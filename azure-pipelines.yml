trigger:
- master

variables:
  # Primary virtual environment used for poetry.
  # Also made available to .ci/scripts/python.py to resolve to the correct
  #  Python.
  venv: .poetry

jobs:

- job: Pipeline
  strategy:
    matrix:
      linux:
        python.version: '3.7'
        imageName: 'ubuntu-16.04'
      windows:
        python.version: '3.7'
        imageName: 'vs2017-win2016'
    maxParallel: 4

  pool:
    vmImage: $(imageName)

  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '$(python.version)'
      architecture: 'x64'

  - task: 1ESLighthouseEng.PipelineArtifactCaching.RestoreCacheV1.RestoreCache@1
    displayName: 'PyPI Cache Restore'
    inputs:
      # TODO: Python version for each artifact?
      keyfile: 'poetry.lock'
      targetfolder: '.venv, $(venv)'
      vstsFeed: '$(CacheArtifactFeedId)'

    # venv is idempotent - no issues if cache has been restored
  - script: python -m venv $(venv)
    displayName: Make Poetry venv

  - task: PythonScript@0
    displayName: Setup Poetry 1
    inputs:
      scriptPath: .ci/scripts/python.py
      arguments: -m pip install --upgrade pip

  - task: PythonScript@0
    displayName: Setup Poetry 2
    inputs:
      scriptPath: .ci/scripts/python.py
      arguments: -m pip install --upgrade poetry

  - task: PythonScript@0
    displayName: Configure Poetry 1
    inputs:
      scriptPath: .ci/scripts/python.py
      arguments: -m poetry config settings.virtualenvs.in-project true

  - task: PythonScript@0
    displayName: Configure Poetry 2
    inputs:
      scriptPath: .ci/scripts/python.py
      arguments: -m poetry config settings.virtualenvs.path .venv

    # Letting Python install the virtual environment works around an issue
    # seen where ensurepip fails when poetry executes the installation.
  - script: python -m venv .venv
    displayName: Make app venv

  - task: PythonScript@0
    displayName: Install/update dependencies
    inputs:
      scriptPath: .ci/scripts/python.py
      arguments: -m poetry install

    # If dependency resolution succeeded, cache.
  - task: 1ESLighthouseEng.PipelineArtifactCaching.SaveCacheV1.SaveCache@1
    displayName: 'PyPI Cache Save'
    inputs:
      keyfile: 'poetry.lock'
      targetfolder: '.venv, $(venv)'
      vstsFeed: '$(CacheArtifactFeedId)'

  - task: PythonScript@0
    displayName: Test
    inputs:
      scriptPath: .ci/scripts/python.py
      arguments: -m poetry run pytest -s -ra --junitxml=junit/test-results.xml tests
